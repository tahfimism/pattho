{% extends "core/layout.html" %}

{% block body %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] mb-6">Dashboard</h1>

    {% for subject in subjects %}
    <div class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg mb-6 overflow-hidden">
        <div class="p-5 border-b border-[var(--color-border-light)] dark:border-[var(--color-border-dark)]">
            <h2 class="text-xl font-semibold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]">{{ subject.name }}</h2>
        </div>
        <div class="divide-y divide-[var(--color-border-light)] dark:divide-[var(--color-border-dark)]">
            {% for chapter in subject.chapters.all %}
            <div class="p-5 chapter-row" data-chapter-id="{{ chapter.id }}">
                <div class="flex items-center justify-between">
                    <div class="flex-grow">
                        <p class="font-semibold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]">{{ chapter.title }}</p>
                    </div>
                    <div class="flex items-center space-x-4 checkbox-group">
                        <label class="flex items-center space-x-2 cursor-pointer" title="Book Read">
                            <input type="checkbox" data-field="p_book" {% if chapter.user_progress.p_book %}checked{% endif %} class="h-5 w-5 rounded border-[var(--color-border-light)] text-[var(--color-success-light)] focus:ring-[var(--color-success-light)]">
                            <i data-lucide="book-open" class="w-5 h-5 text-[var(--color-gray-text-light)]"></i>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer" title="Note Taken">
                            <input type="checkbox" data-field="p_note" {% if chapter.user_progress.p_note %}checked{% endif %} class="h-5 w-5 rounded border-[var(--color-border-light)] text-[var(--color-success-light)] focus:ring-[var(--color-success-light)]">
                            <i data-lucide="file-text" class="w-5 h-5 text-[var(--color-gray-text-light)]"></i>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer" title="MCQ Practice">
                            <input type="checkbox" data-field="p_mcq" {% if chapter.user_progress.p_mcq %}checked{% endif %} class="h-5 w-5 rounded border-[var(--color-border-light)] text-[var(--color-success-light)] focus:ring-[var(--color-success-light)]">
                            <i data-lucide="list-checks" class="w-5 h-5 text-[var(--color-gray-text-light)]"></i>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer" title="CQ Practice">
                            <input type="checkbox" data-field="p_cq" {% if chapter.user_progress.p_cq %}checked{% endif %} class="h-5 w-5 rounded border-[var(--color-border-light)] text-[var(--color-success-light)] focus:ring-[var(--color-success-light)]">
                            <i data-lucide="pencil" class="w-5 h-5 text-[var(--color-gray-text-light)]"></i>
                        </label>
                        <label class="flex items-center space-x-2 cursor-pointer" title="Theory Complete">
                            <input type="checkbox" data-field="p_theory" {% if chapter.user_progress.p_theory %}checked{% endif %} class="h-5 w-5 rounded border-[var(--color-border-light)] text-[var(--color-success-light)] focus:ring-[var(--color-success-light)]">
                            <i data-lucide="brain-circuit" class="w-5 h-5 text-[var(--color-gray-text-light)]"></i>
                        </label>
                    </div>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">Progress</span>
                        <span class="text-sm font-medium text-[var(--color-primary-light)] dark:text-[var(--color-primary-dark)] progress-text">{{ chapter.user_progress.overall_progress|default:0 }}%</span>
                    </div>
                    <div class="w-full bg-[var(--color-gray-bg-light)] rounded-full h-2.5 dark:bg-[var(--color-gray-bg-dark)]">
                        <div class="bg-[var(--color-primary-light)] h-2.5 rounded-full progress-bar" style="width: {{ chapter.user_progress.overall_progress|default:0 }}%;"></div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Dashboard script initialized.");

    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value;
    let pendingChanges = {};
    let debounceTimer;

    // To change the auto-save delay, modify the value below (in milliseconds).
    const DEBOUNCE_DELAY = 5000; // 10 seconds

    const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const chapterRow = this.closest('.chapter-row');
            const chapterId = chapterRow.dataset.chapterId;
            const field = this.dataset.field;
            const isChecked = this.checked;

            console.log(`Change detected: Chapter ${chapterId}, Field ${field}, Status ${isChecked}`);

            // Instantly update the UI for a responsive feel.
            updateChapterProgressUI(chapterRow);

            // Add the change to our pending queue for saving.
            if (!pendingChanges[chapterId]) {
                pendingChanges[chapterId] = {};
            }
            pendingChanges[chapterId][field] = isChecked;

            // Reset the debounce timer to save changes after a period of inactivity.
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(saveProgress, DEBOUNCE_DELAY);

            console.log(`Debounce timer reset. Will save in ${DEBOUNCE_DELAY / 1000} seconds.`);
        });
    });

    function updateChapterProgressUI(chapterRow) {
        const chapterCheckboxes = chapterRow.querySelectorAll('.checkbox-group input[type="checkbox"]');
        const totalCheckboxes = chapterCheckboxes.length;
        const checkedCount = Array.from(chapterCheckboxes).filter(cb => cb.checked).length;
        const newProgress = totalCheckboxes > 0 ? Math.round((checkedCount / totalCheckboxes) * 100) : 0;

        console.log(`Updating UI instantly for Chapter ${chapterRow.dataset.chapterId}. New calculated progress: ${newProgress}%`);

        const progressBar = chapterRow.querySelector('.progress-bar');
        const progressText = chapterRow.querySelector('.progress-text');

        if (progressBar) progressBar.style.width = newProgress + '%';
        if (progressText) progressText.textContent = newProgress + '%';
    }

    function saveProgress() {
        if (Object.keys(pendingChanges).length === 0) {
            console.log("No pending changes to save.");
            return;
        }

        console.log("Saving progress to server...", pendingChanges);

        // Make a copy of the changes and clear the queue immediately.
        const changesToSave = pendingChanges;
        pendingChanges = {};

        fetch(`{% url 'update_progress' %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ changes: changesToSave })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok (${response.status})`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log("Progress saved successfully. Syncing UI with server state:", data);
                // Sync the UI with the authoritative progress from the server.
                for (const chapterId in data.new_progress) {
                    const chapterRow = document.querySelector(`.chapter-row[data-chapter-id="${chapterId}"]`);
                    if (chapterRow) {
                        const serverProgress = data.new_progress[chapterId];
                        console.log(`Syncing Chapter ${chapterId} to server progress: ${serverProgress}%`);
                        const progressBar = chapterRow.querySelector('.progress-bar');
                        const progressText = chapterRow.querySelector('.progress-text');
                        if (progressBar) progressBar.style.width = serverProgress + '%';
                        if (progressText) progressText.textContent = serverProgress + '%';
                    }
                }
            } else {
                console.error('Failed to save progress:', data.error);
                // Note: In a real-world app, you might want to add logic here to restore the pending changes
                // and alert the user that saving failed.
            }
        })
        .catch(error => {
            console.error('Error saving progress:', error);
        });
    }

    // Save any remaining changes when the user tries to leave the page.
    window.addEventListener('beforeunload', function(event) {
        if (Object.keys(pendingChanges).length > 0) {
            console.log("User is leaving. Saving pending changes immediately.");
            saveProgress();
            // This message is usually not shown in modern browsers, but is required for the event to trigger.
            event.preventDefault();
            event.returnValue = 'Your changes are being saved.';
        }
    });

    // Expose pendingChanges and saveProgress to a global object for use in other scripts (e.g., layout.html)
    window.app = window.app || {};
    window.app.pendingChanges = pendingChanges;
    window.app.saveProgress = saveProgress;

    // Initialize Lucide icons
    lucide.createIcons();
    console.log("Lucide icons initialized.");
});
</script>
{% endblock %}