{% load static %}
{% load sidebar_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pattho</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Baloo+Da+2:wght@400..800&family=Bytesized&family=Comic+Neue:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&family=Doto:wght@100..900&family=Hind+Siliguri:wght@300;400;500;600;700&family=Noto+Sans+Bengali:wght@100..900&family=Noto+Serif+Bengali:wght@100..900&family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">


    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>


    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
        <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>




    <link rel="stylesheet" href="{% static 'core/main.css' %}">

</head>
<body class="bg-[var(--color-bg-light)] text-[var(--color-text-light)] dark:bg-[var(--color-bg-dark)] dark:text-[var(--color-text-dark)] flex min-h-screen">

    <!-- Mobile Header (always visible on mobile, hidden on desktop) -->
    <div id="mobile-header" class="md:hidden bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg p-4 flex items-center justify-between fixed top-0 left-0 right-0 z-50">
        <button id="hamburger-menu-btn" class="p-2 rounded-full text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)] hover:bg-[var(--color-gray-bg-light)] dark:hover:bg-[var(--color-gray-bg-dark)] transition-colors duration-200">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <h1 class="text-2xl font-bold text-[var(--color-primary-light)] dark:text-[var(--color-primary-dark)] flex-grow text-center" id="logo-name-mobile">পাঠ্য</h1>
        <button id="mobile-right-sidebar-btn" class="p-2 rounded-full text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)] hover:bg-[var(--color-gray-bg-light)] dark:hover:bg-[var(--color-gray-bg-dark)] transition-colors duration-200">
            <i data-lucide="chart-no-axes-combined" class="w-6 h-6"></i>
        </button>
    </div>

    <!-- Left Sidebar (fixed on desktop, slides in/out on mobile) -->
    <aside id="left-sidebar" class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-xl flex flex-col justify-between w-64 flex-shrink-0 h-screen fixed top-0 left-0 z-40 md:translate-x-0 -translate-x-full transition-transform duration-300 ease-in-out md:pt-0 pt-16">
        <!-- Logo/Name for Desktop (always visible when sidebar is open) -->
        <div class="pl-14 mb-3 hidden md:block pt-8">
            <img src="{% static 'core/logo_trans.png' %}" alt="Pattho Logo" class="h-11 w-auto">
        </div>
        <div class="p-6 flex-grow sidebar-scroll overflow-y-auto">
            <!-- Navigation Links -->
            <nav>
                <ul>
                    <li class="mb-2">
                        <a href="{% url 'dashboard' %}" class="flex items-center p-3 rounded-xl text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] hover:bg-[var(--color-primary-hover-light)] dark:hover:bg-[var(--color-primary-hover-dark)] hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-text-dark)] transition-colors duration-200 font-medium">
                            <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'planner' %}" class="flex items-center p-3 rounded-xl text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] hover:bg-[var(--color-primary-hover-light)] dark:hover:bg-[var(--color-primary-hover-dark)] hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-text-dark)] transition-colors duration-200 font-medium">
                            <i data-lucide="calendar-check" class="w-5 h-5 mr-3"></i>
                            Study Planner
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'activities' %}" class="flex items-center p-3 rounded-xl text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] hover:bg-[var(--color-primary-hover-light)] dark:hover:bg-[var(--color-primary-hover-dark)] hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-text-dark)] transition-colors duration-200 font-medium">
                            <i data-lucide="list-todo" class="w-5 h-5 mr-3"></i>
                            To-do
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'pomodoro' %}" class="flex items-center p-3 rounded-xl text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] hover:bg-[var(--color-primary-hover-light)] dark:hover:bg-[var(--color-primary-hover-dark)] hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-text-dark)] transition-colors duration-200 font-medium">
                            <i data-lucide="timer" class="w-5 h-5 mr-3"></i>
                            Pomodoro
                        </a>
                    </li>
                    
                    <li class="mb-2">
                        <a href="{% url 'leaderboard' %}" class="flex items-center p-3 rounded-xl text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] hover:bg-[var(--color-primary-hover-light)] dark:hover:bg-[var(--color-primary-hover-dark)] hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-text-dark)] transition-colors duration-200 font-medium">
                            <i data-lucide="trophy" class="w-5 h-5 mr-3"></i>
                            Leaderboard 
                        </a>
                    </li>
                    <li class="mb-2">
                        <a href="{% url 'profile' %}" class="flex items-center p-3 rounded-xl text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] hover:bg-[var(--color-primary-hover-light)] dark:hover:bg-[var(--color-primary-hover-dark)] hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-text-dark)] transition-colors duration-200 font-medium">
                            <i data-lucide="user" class="w-5 h-5 mr-3"></i>
                            Profile / Settings
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- User Streak, Avatar -->
        <div class="p-6">
            <div class="flex items-center mb-4 text-sm font-medium text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">
                <i data-lucide="flame" class="w-4 h-4 mr-2 text-[var(--color-accent-light)]"></i>
                <span>Streak: {{ request.user.streak|default:0 }} Days</span>
            </div>
            <div class="flex items-center pt-4 border-t border-[var(--color-border-light)] dark:border-[var(--color-border-dark)]">
                <img src="{{ request.user.avatar|default:'https://placehold.co/40x40/a78bfa/ffffff?text=U' }}" alt="User Avatar" class="w-10 h-10 rounded-full mr-3 border-2 border-[var(--color-primary-light)] dark:border-[var(--color-primary-dark)]">
                <div>
                    <p class="font-semibold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]">{{ request.user.first_name }} {{ request.user.last_name }}</p>
                    <p class="text-sm text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">{{ request.user.get_stream_display }} {{ request.user.hscyear }}</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content and Right Sidebar Wrapper -->
    <div class="flex-1 flex flex-col md:ml-64 md:mr-72 pt-16 md:pt-0"> <!-- Added pt-16 for mobile header offset -->
        <!-- Content Area: Main Content + Right Sidebar -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Main Content Area - This is where your Django content will be injected -->
            <main class="p-6 flex-1 overflow-y-auto bg-[var(--color-card-bg-light)] dark:bg-[var(--color-bg-dark)] shadow-lg min-h-[300px] min-w-[688px]">
                {% block body %}
                This is the main content area. Your Django views will render content here.
                {% endblock %}
            </main>

            <!-- Right Sidebar -->
            {% block right_sidebar %}
            <aside id="right-sidebar" class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-xl w-72 flex-shrink-0 p-6 overflow-y-auto sidebar-scroll fixed top-0 right-0 h-full transform translate-x-full md:translate-x-0 md:block transition-transform duration-300 ease-in-out z-40 pt-20 md:pt-11">
                {% subject_progress_sidebar %}

                <div class="border-b border-[var(--color-border-light)] dark:border-[var(--color-border-dark)] pb-6 mb-6"></div>

                <h3 class="text-lg font-semibold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] mb-4 mt-6">Incomplete Tasks</h3>
                <ul id="incomplete-tasks-list" class="space-y-2">
                    <!-- Tasks will be loaded here by JavaScript -->
                    <li class="text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">Loading tasks...</li>
                </ul>
            </aside>
            {% endblock right_sidebar %}
        </div>
    </div>

    <!-- Overlay for mobile right sidebar -->
    <div id="right-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Overlay for mobile left sidebar -->
    <div id="left-sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

    <!-- Initialize Lucide icons (needed for icons to display) -->
    <script>
        lucide.createIcons();
    </script>

    {% block extra_js_vars %}{% endblock %}

    <script src="{% static 'core/dash.js' %}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const refreshButton = document.getElementById('refresh-progress-btn');
            const subjectList = document.getElementById('subject-progress-list');
            const incompleteTasksList = document.getElementById('incomplete-tasks-list');
            const mobileRightSidebarBtn = document.getElementById('mobile-right-sidebar-btn');
            const rightSidebar = document.getElementById('right-sidebar');
            const rightSidebarOverlay = document.getElementById('right-sidebar-overlay');

            // Function to fetch and display incomplete tasks
            async function fetchIncompleteTasks() {
                try {
                    const response = await fetch('{% url 'api_incomplete_tasks' %}');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    if (incompleteTasksList) {
                        incompleteTasksList.innerHTML = ''; // Clear loading message
                        if (data.incomplete_tasks && data.incomplete_tasks.length > 0) {
                            data.incomplete_tasks.forEach(task => {
                                const listItem = document.createElement('li');
                                listItem.className = 'flex items-center space-x-2 text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]';
                                const iconSpan = document.createElement('span');
                                iconSpan.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-git-commit-horizontal"><path d="M12 3v18"/><path d="M3 12h18"/><circle cx="12" cy="12" r="3"/></svg>';
                                const taskTitleSpan = document.createElement('span');
                                taskTitleSpan.textContent = task.title;
                                listItem.appendChild(iconSpan);
                                listItem.appendChild(taskTitleSpan);
                                incompleteTasksList.appendChild(listItem);
                            });
                        } else {
                            const listItem = document.createElement('li');
                            listItem.className = 'text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]';
                            listItem.textContent = 'No incomplete tasks!';
                            incompleteTasksList.appendChild(listItem);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching incomplete tasks:', error);
                    if (incompleteTasksList) {
                        incompleteTasksList.innerHTML = '<li class="text-red-500">Failed to load tasks.</li>';
                    }
                }
            }

            // Call fetchIncompleteTasks on page load
            fetchIncompleteTasks();

            if (refreshButton && subjectList) {
                refreshButton.addEventListener('click', async function() { // Added 'async'
                    console.log("Refresh button clicked.");
                    const icon = refreshButton.querySelector('svg'); // Lucide replaces <i> with <svg>
                    icon.classList.add('animate-spin'); // Add spinning animation

                    try {
                        // Check if there are pending changes from the dashboard script
                        if (window.app && window.app.pendingChanges && Object.keys(window.app.pendingChanges).length > 0) {
                            console.log("Pending chapter changes detected. Forcing save before refreshing subject progress.");
                            await window.app.saveProgress(); // Wait for the save to complete
                            console.log("Pending chapter changes saved.");
                        } else {
                            console.log("No pending chapter changes. Proceeding with subject progress refresh.");
                        }

                        const response = await fetch('{% url 'api_subject_progress' %}');
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        const data = await response.json();

                        console.log("Received subject progress data:", data);
                        if (data.success && data.subjects_progress) {
                            data.subjects_progress.forEach(subject => {
                                const listItem = subjectList.querySelector(`li[data-subject-name="${subject.name}"]`);
                                if (listItem) {
                                    const percentageSpan = listItem.querySelector('.subject-progress-percentage');
                                    const progressBar = listItem.querySelector('.subject-progress-bar');

                                    if (percentageSpan) percentageSpan.textContent = `${subject.overall_progress}%`;
                                    if (progressBar) progressBar.style.width = `${subject.overall_progress}%`;
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Error during subject progress refresh:', error);
                    } finally {
                        icon.classList.remove('animate-spin'); // Remove spinning animation
                        lucide.createIcons(); // Re-initialize icons in case new ones were added or changed
                    }
                });
            }

            // Mobile right sidebar toggle
            if (mobileRightSidebarBtn && rightSidebar && rightSidebarOverlay) {
                mobileRightSidebarBtn.addEventListener('click', function() {
                    rightSidebar.classList.toggle('translate-x-full');
                    rightSidebarOverlay.classList.toggle('hidden');
                });

                rightSidebarOverlay.addEventListener('click', function() {
                    rightSidebar.classList.add('translate-x-full');
                    rightSidebarOverlay.classList.add('hidden');
                });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hamburgerBtn = document.getElementById('hamburger-menu-btn');
            const leftSidebar = document.getElementById('left-sidebar');
            const leftSidebarOverlay = document.getElementById('left-sidebar-overlay');

            if (hamburgerBtn && leftSidebar && leftSidebarOverlay) {
                hamburgerBtn.addEventListener('click', function() {
                    leftSidebar.classList.toggle('-translate-x-full');
                    leftSidebarOverlay.classList.toggle('hidden');
                });

                leftSidebarOverlay.addEventListener('click', function() {
                    leftSidebar.classList.add('-translate-x-full');
                    leftSidebarOverlay.classList.add('hidden');
                });
            }
        });
    </script>
</body>
</html>
