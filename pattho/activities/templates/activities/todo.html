{% extends "core/layout.html" %}
{% load static %}

{% block body %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col gap-6">
        <!-- Pomodoro Timer Section -->
        <div class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg rounded-lg p-6 flex flex-col items-center justify-center">
            <div class="flex justify-between items-center w-full mb-6">
                <h2 class="text-3xl font-bold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]">Pomodoro</h2>
                <!-- Tabs for Work/Break -->
                <div class="flex bg-[var(--color-card-bg-dark)] rounded-full p-1 shadow-inner">
                    <button id="work-tab" class="flex-1 px-4 py-1 text-lg transition-colors duration-200 rounded-full text-white bg-[var(--color-gray-bg-dark)]">Work</button>
                    <button id="break-tab" class="flex-1 px-4 py-1 text-lg transition-colors duration-200 rounded-full text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] hover:bg-opacity-80">Break</button>
                </div>
            </div>

            <div class="relative w-80 h-80 flex items-center justify-center rounded-full border-8 border-[var(--color-primary-light)] dark:border-[var(--color-primary-dark)] mb-8">
                <div class="text-7xl font-normal font-['Courier_Prime'] text-[var(--color-primary-light)] dark:text-[var(--color-primary-dark)]" id="timer-display">25:00</div>
                <p class="absolute bottom-16 text-md text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]" id="timer-label">Focus Time</p>
            </div>
            <div class="flex space-x-4 mb-4">
                <button id="start-timer" class="bg-[var(--color-success-light)] hover:bg-[var(--color-success-dark)] text-white py-2 px-4 rounded-lg transition-colors duration-200 shadow-md flex items-center">
                    <i data-lucide="play" class="w-4 h-4 mr-2"></i> Start
                </button>
                <button id="pause-timer" class="bg-[var(--color-gray-bg-light)] dark:bg-[var(--color-gray-bg-dark)] text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] py-2 px-4 rounded-lg transition-colors duration-200 shadow-md hover:bg-[var(--color-gray-bg-light)] hover:bg-opacity-80 dark:hover:bg-[var(--color-gray-bg-dark)] dark:hover:bg-opacity-80">Pause</button>
                <button id="reset-timer" class="bg-[var(--color-gray-bg-light)] dark:bg-[var(--color-gray-bg-dark)] text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] py-2 px-4 rounded-lg transition-colors duration-200 shadow-md hover:bg-[var(--color-gray-bg-light)] hover:bg-opacity-80 dark:hover:bg-[var(--color-gray-bg-dark)] dark:hover:bg-opacity-80">Reset</button>
            </div>
            
        </div>
        <!-- To-Do List Section -->
        <div class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-3xl font-bold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]">My To-Do List</h1>
                    <p class="text-md text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">Manage your tasks and boost productivity</p>
                </div>
                <form action="{% url 'add_todo' %}" method="post" class="flex items-center">
                    {% csrf_token %}
                    <input type="text" name="title" placeholder="Add a new to-do item" class="hidden md:block p-3 rounded-l-lg border border-[var(--color-border-light)] dark:border-[var(--color-border-dark)] bg-[var(--color-gray-bg-light)] dark:bg-[var(--color-gray-bg-dark)] text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary-light)] focus:border-transparent">
                    <button type="submit" class="bg-[var(--color-primary-light)] hover:bg-[var(--color-primary-hover-light)] dark:bg-[var(--color-primary-dark)] dark:hover:bg-[var(--color-primary-hover-dark)] text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 shadow-md">
                        Add Task
                    </button>
                </form>
            </div>

            <div class="divide-y divide-[var(--color-border-light)] dark:divide-[var(--color-border-dark)]">
                {% for todo in todos %}
                <div class="flex items-center justify-between p-4 {% if todo.completed %}opacity-60{% endif %}">
                    <div class="flex items-center">
                        <form action="{% url 'toggle_todo' todo.id %}" method="post" class="flex items-center">
                            {% csrf_token %}
                            <input type="checkbox" onchange="this.form.submit()" {% if todo.completed %}checked{% endif %} class="h-5 w-5 rounded border-[var(--color-border-light)] text-[var(--color-success-light)] focus:ring-[var(--color-success-light)] cursor-pointer">
                            <span class="ml-3 text-lg {% if todo.completed %}line-through text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]{% else %}text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]{% endif %}">
                                {{ todo.title }}
                            </span>
                        </form>
                    </div>
                    <span class="text-sm text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">
                        {{ todo.date|date:"M d, Y" }}
                    </span>
                </div>
                {% empty %}
                <p class="p-4 text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">No to-do items yet. Add one above!</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>


<script>
    console.log("Pomodoro script loaded!");
    const timerDisplay = document.getElementById('timer-display');
    const timerLabel = document.getElementById('timer-label');
    const startButton = document.getElementById('start-timer');
    const pauseButton = document.getElementById('pause-timer');
    const resetButton = document.getElementById('reset-timer');
    const workTab = document.getElementById('work-tab');
    const breakTab = document.getElementById('break-tab');

    const FOCUS_TIME = 25 * 60; // 25 minutes
    const SHORT_BREAK = 5 * 60; // 5 minutes
    const LONG_BREAK = 15 * 60; // 15 minutes

    let timeLeft = FOCUS_TIME;
    let timerId = null;
    let currentMode = 'focus'; // 'focus', 'short-break', 'long-break'
    let pomodoroCount = 0;

    function updateDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function setMode(mode) {
        currentMode = mode;
        clearInterval(timerId);
        timerId = null;

        workTab.classList.remove('bg-[var(--color-gray-bg-dark)]', 'text-white');
        breakTab.classList.remove('bg-[var(--color-gray-bg-dark)]', 'text-white');
        workTab.classList.add('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
        breakTab.classList.add('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');

        // Manage hover effects for toggle buttons
        workTab.classList.remove('hover:bg-opacity-80');
        breakTab.classList.remove('hover:bg-opacity-80');

        if (mode === 'focus') {
            timeLeft = FOCUS_TIME;
            timerLabel.textContent = 'Focus Time';
            workTab.classList.add('bg-[var(--color-gray-bg-dark)]', 'text-white');
            workTab.classList.remove('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
            breakTab.classList.add('hover:bg-opacity-80'); // Add hover to inactive break tab
        } else if (mode === 'short-break') {
            timeLeft = SHORT_BREAK;
            timerLabel.textContent = 'Short Break';
            breakTab.classList.add('bg-[var(--color-gray-bg-dark)]', 'text-white');
            breakTab.classList.remove('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
            workTab.classList.add('hover:bg-opacity-80'); // Add hover to inactive work tab
        } else if (mode === 'long-break') {
            timeLeft = LONG_BREAK;
            timerLabel.textContent = 'Long Break';
            breakTab.classList.add('bg-[var(--color-gray-bg-dark)]', 'text-white');
            breakTab.classList.remove('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
            workTab.classList.add('hover:bg-opacity-80'); // Add hover to inactive work tab
        }
        updateDisplay();
    }

    function startTimer() {
        if (timerId) return; // Prevent multiple timers
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                timerId = null;
                playAlarmSound();
                switchMode();
            }
        }, 1000);
    }

    function pauseTimer() {
        clearInterval(timerId);
        timerId = null;
    }

    function resetTimer() {
        pauseTimer();
        setMode(currentMode); // Reset to the current mode's initial time
    }

    function switchMode() {
        if (currentMode === 'focus') {
            pomodoroCount++;
            if (pomodoroCount % 4 === 0) {
                setMode('long-break');
            } else {
                setMode('short-break');
            }
        } else {
            setMode('focus');
        }
        startTimer(); // Automatically start the next timer
    }

    function playAlarmSound() {
        const audio = new Audio('https://www.soundjay.com/buttons/beep-07.wav'); // Using a public domain sound for demonstration
        audio.play();
    }

    startButton.addEventListener('click', startTimer);
    pauseButton.addEventListener('click', pauseTimer);
    resetButton.addEventListener('click', resetTimer);
    workTab.addEventListener('click', () => setMode('focus'));
    breakTab.addEventListener('click', () => setMode('short-break')); // Default break to short break

    // Initial display update
    updateDisplay();
</script>
{% endblock %}