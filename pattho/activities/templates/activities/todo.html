{% extends "core/layout.html" %}
{% load static %}

{% block body %}
<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col gap-6">
        <!-- Pomodoro Timer Section -->
        <div class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg rounded-lg p-6 flex flex-col items-center justify-center">
            <div class="flex justify-between items-center w-full mb-6">
                                <div class="flex items-center gap-2">
                    <h2 class="text-3xl font-bold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]">Pomodoro</h2>
                    <div class="relative group">
                        <i data-lucide="help-circle" class="w-5 h-5 text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)] cursor-pointer"></i>
                        <div class="absolute top-full mt-2 w-64 bg-[var(--color-card-bg-dark)] text-white text-sm rounded-lg p-3 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none z-10">
                            The Pomodoro Technique is a time management method. Work for 25 minutes, then take a short 5-minute break. After four work intervals, take a longer 15-minute break.
                            <div class="absolute left-1/2 -translate-x-1/2 bottom-full w-0 h-0 border-x-8 border-x-transparent border-b-8 border-b-[var(--color-card-bg-dark)]"></div>
                        </div>
                    </div>
                </div>
                <!-- Tabs for Work/Break -->
                <div class="flex bg-[var(--color-card-bg-dark)] rounded-full p-1 shadow-inner">
                    <button id="work-tab" class="flex-1 px-4 py-1 text-lg transition-colors duration-200 rounded-full text-white bg-[var(--color-gray-bg-dark)]">Work</button>
                    <button id="break-tab" class="flex-1 px-4 py-1 text-lg transition-colors duration-200 rounded-full text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] hover:bg-opacity-80">Break</button>
                </div>
            </div>

            <div class="relative flex flex-col items-center justify-center mb-8">
                <div class="text-7xl font-normal font-['Courier_Prime'] text-[var(--color-primary-light)] dark:text-[var(--color-primary-dark)]" id="timer-display">25:00</div>
                <p class="text-md text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]" id="timer-label">Focus Time</p>
            </div>
            <div class="flex space-x-4 mb-4">
                <button id="start-timer" class="bg-[var(--color-success-light)] hover:bg-[var(--color-success-dark)] text-white py-2 px-4 rounded-lg transition-colors duration-200 shadow-md flex items-center">
                    <i data-lucide="play" class="w-4 h-4 mr-2"></i> Start
                </button>
                <button id="pause-timer" class="bg-[var(--color-gray-bg-light)] dark:bg-[var(--color-gray-bg-dark)] text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] py-2 px-4 rounded-lg transition-colors duration-200 shadow-md hover:bg-[var(--color-gray-bg-light)] hover:bg-opacity-80 dark:hover:bg-[var(--color-gray-bg-dark)] dark:hover:bg-opacity-80">Pause</button>
                <button id="reset-timer" class="bg-[var(--color-gray-bg-light)] dark:bg-[var(--color-gray-bg-dark)] text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] py-2 px-4 rounded-lg transition-colors duration-200 shadow-md hover:bg-[var(--color-gray-bg-light)] hover:bg-opacity-80 dark:hover:bg-[var(--color-gray-bg-dark)] dark:hover:bg-opacity-80">Reset</button>
            </div>
        </div>

        <!-- Task Summary Metrics Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg rounded-lg p-4 text-center transition-colors duration-300 hover:bg-[var(--color-bg-light)] dark:hover:bg-[var(--color-bg-dark)] cursor-pointer">
                <p class="text-sm text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">Total Tasks</p>
                <p class="text-3xl font-bold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]" id="total-tasks">0</p>
            </div>
            <div class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg rounded-lg p-4 text-center transition-colors duration-300 hover:bg-[var(--color-bg-light)] dark:hover:bg-[var(--color-bg-dark)] cursor-pointer">
                <p class="text-sm text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">Completed</p>
                <p class="text-3xl font-bold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]" id="completed-tasks">0</p>
            </div>
            <div class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg rounded-lg p-4 text-center transition-colors duration-300 hover:bg-[var(--color-bg-light)] dark:hover:bg-[var(--color-bg-dark)] cursor-pointer">
                <p class="text-sm text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">Due Today</p>
                <p class="text-3xl font-bold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]" id="due-today-tasks">0</p>
            </div>
            <div class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg rounded-lg p-4 text-center transition-colors duration-300 hover:bg-[var(--color-bg-light)] dark:hover:bg-[var(--color-bg-dark)] cursor-pointer">
                <p class="text-sm text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">Overdue</p>
                <p class="text-3xl font-bold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]" id="overdue-tasks">0</p>
            </div>
        </div>
        <!-- To-Do List Section -->
        <div class="bg-[var(--color-card-bg-light)] dark:bg-[var(--color-card-bg-dark)] shadow-lg rounded-lg p-6">
            <div class="flex flex-col md:flex-row flex-wrap justify-between items-start md:items-center mb-4 md:gap-x-4">
                <div class="mb-6 flex-shrink-0">
                    <h1 class="text-3xl font-bold text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]">My To-Do List</h1>
                    
                </div>
                <form action="{% url 'add_todo' %}" method="post" class="flex items-center w-full">
                    {% csrf_token %}
                    <input type="text" name="title" placeholder="Add a new to-do item" class="p-3 rounded-l-lg border border-[var(--color-border-light)] dark:border-[var(--color-border-dark)] bg-[var(--color-gray-bg-light)] dark:bg-[var(--color-gray-bg-dark)] text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] focus:outline-none focus:ring-2 focus:ring-[var(--color-primary-light)] focus:border-transparent flex-grow">
                    <button type="submit" class="bg-[var(--color-primary-light)] hover:bg-[var(--color-primary-hover-light)] dark:bg-[var(--color-primary-dark)] dark:hover:bg-[var(--color-primary-hover-dark)] text-white font-bold py-3 px-6 rounded-r-lg transition-colors duration-200 shadow-md">
            
                        Add Task
                    </button>
                </form>
            </div>

            <div class="divide-y divide-[var(--color-border-light)] dark:divide-[var(--color-border-dark)]">
                {% for todo in todos %}
                <div class="flex items-center justify-between p-4 {% if todo.completed %}opacity-60{% endif %}">
                    <div class="flex items-center">
                        <form action="{% url 'toggle_todo' todo.id %}" method="post" class="flex items-center toggle-todo-form" data-todo-id="{{ todo.id }}">
                            {% csrf_token %}
                            <input type="checkbox" {% if todo.completed %}checked{% endif %} class="h-5 w-5 rounded border-[var(--color-border-light)] text-[var(--color-success-light)] focus:ring-[var(--color-success-light)] cursor-pointer todo-checkbox">
                            <span class="ml-3 text-lg {% if todo.completed %}line-through text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]{% else %}text-[var(--color-text-light)] dark:text-[var(--color-text-dark)]{% endif %} todo-title-display">
                                {{ todo.title }}
                            </span>
                            <input type="text" value="{{ todo.title }}" class="hidden ml-3 p-1 rounded border border-[var(--color-border-light)] dark:border-[var(--color-border-dark)] bg-[var(--color-gray-bg-light)] dark:bg-[var(--color-gray-bg-dark)] text-[var(--color-text-light)] dark:text-[var(--color-text-dark)] focus:outline-none focus:ring-1 focus:ring-[var(--color-primary-light)] todo-title-input">
                        </form>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">
                            {{ todo.date|date:"M d, Y" }}
                        </span>
                        <button class="text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)] hover:text-[var(--color-primary-light)] dark:hover:text-[var(--color-primary-dark)] transition-colors duration-200 edit-todo-btn" data-todo-id="{{ todo.id }}">
                            <i data-lucide="edit" class="w-4 h-4 edit-icon"></i>
                            <i data-lucide="save" class="w-4 h-4 save-icon hidden"></i>
                        </button>
                        <button class="text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)] hover:text-[var(--color-error-light)] dark:hover:text-[var(--color-error-dark)] transition-colors duration-200 delete-todo-btn" data-todo-id="{{ todo.id }}">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
                {% empty %}
                <p class="p-4 text-[var(--color-gray-text-light)] dark:text-[var(--color-gray-text-dark)]">No to-do items yet. Add one above!</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<audio id="alarm-sound" preload="auto">
    <source src="/static/activities/complete.wav" type="audio/wav">
    Your browser does not support the audio element.
</audio>

<script>
    console.log("Pomodoro script loaded!");
    const timerDisplay = document.getElementById('timer-display');
    const timerLabel = document.getElementById('timer-label');
    const startButton = document.getElementById('start-timer');
    const pauseButton = document.getElementById('pause-timer');
    const resetButton = document.getElementById('reset-timer');
    const workTab = document.getElementById('work-tab');
    const breakTab = document.getElementById('break-tab');
    const alarmSound = document.getElementById('alarm-sound');


    const FOCUS_TIME = 25 * 60; // 25 minutes
    const SHORT_BREAK = 5 * 60; // 5 minutes
    const LONG_BREAK = 15 * 60; // 15 minutes

    let timeLeft = FOCUS_TIME;
    let timerId = null;
    let currentMode = 'focus'; // 'focus', 'short-break', 'long-break'
    let pomodoroCount = 0;

    function updateDisplay() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${minutes < 10 ? '0' : ''}${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
    }

    function setMode(mode) {
        currentMode = mode;
        clearInterval(timerId);
        timerId = null;

        workTab.classList.remove('bg-[var(--color-gray-bg-dark)]', 'text-white');
        breakTab.classList.remove('bg-[var(--color-gray-bg-dark)]', 'text-white');
        workTab.classList.add('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
        breakTab.classList.add('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');

        // Manage hover effects for toggle buttons
        workTab.classList.remove('hover:bg-opacity-80');
        breakTab.classList.remove('hover:bg-opacity-80');

        if (mode === 'focus') {
            timeLeft = FOCUS_TIME;
            timerLabel.textContent = 'Focus Time';
            workTab.classList.add('bg-[var(--color-gray-bg-dark)]', 'text-white');
            workTab.classList.remove('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
            breakTab.classList.add('hover:bg-opacity-80'); // Add hover to inactive break tab
        } else if (mode === 'short-break') {
            timeLeft = SHORT_BREAK;
            timerLabel.textContent = 'Short Break';
            breakTab.classList.add('bg-[var(--color-gray-bg-dark)]', 'text-white');
            breakTab.classList.remove('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
            workTab.classList.add('hover:bg-opacity-80'); // Add hover to inactive work tab
        } else if (mode === 'long-break') {
            timeLeft = LONG_BREAK;
            timerLabel.textContent = 'Long Break';
            breakTab.classList.add('bg-[var(--color-gray-bg-dark)]', 'text-white');
            breakTab.classList.remove('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
            workTab.classList.add('hover:bg-opacity-80'); // Add hover to inactive work tab
        }
        updateDisplay();
    }

    function startTimer() {
        if (timerId) return; // Prevent multiple timers
        alarmSound.load(); // Prepare the audio for playback on user interaction
        timerId = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if (timeLeft <= 0) {
                clearInterval(timerId);
                timerId = null;
                playAlarmSound();
                switchMode();
            }
        }, 1000);
    }

    function pauseTimer() {
        clearInterval(timerId);
        timerId = null;
    }

    function resetTimer() {
        pauseTimer();
        setMode(currentMode); // Reset to the current mode's initial time
    }

    function switchMode() {
        if (currentMode === 'focus') {
            pomodoroCount++;
            if (pomodoroCount % 4 === 0) {
                setMode('long-break');
            } else {
                setMode('short-break');
            }
        } else {
            setMode('focus');
        }
        updateDisplay(); // Ensure display is updated for the new mode
    }

    function playAlarmSound() {
        alarmSound.currentTime = 0;
        alarmSound.play().catch(error => {
            console.error("Failed to play alarm sound:", error);
        });
    }

    startButton.addEventListener('click', startTimer);
    pauseButton.addEventListener('click', pauseTimer);
    resetButton.addEventListener('click', resetTimer);
    workTab.addEventListener('click', () => setMode('focus'));
    breakTab.addEventListener('click', () => setMode('short-break')); // Default break to short break

    // Initial display update
    updateDisplay();

    // Function to fetch and update task summary
    async function fetchTaskSummary() {
        try {
            const response = await fetch('{% url 'api_task_summary' %}');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            document.getElementById('total-tasks').textContent = data.total_tasks;
            document.getElementById('completed-tasks').textContent = data.completed_tasks;
            document.getElementById('due-today-tasks').textContent = data.due_today_tasks;
            document.getElementById('overdue-tasks').textContent = data.overdue_tasks;

        } catch (error) {
            console.error('Error fetching task summary:', error);
        }
    }

    // Fetch task summary on page load
    fetchTaskSummary();

    // Handle checkbox toggling via AJAX
    document.querySelectorAll('.todo-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', async function(event) {
            event.preventDefault(); // Prevent default form submission

            const form = this.closest('.toggle-todo-form');
            const todoId = form.dataset.todoId;
            const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value;
            const listItem = this.closest('div.flex.items-center.justify-between'); // The parent div of the task item
            const span = listItem.querySelector('span.todo-title-display');
            const input = listItem.querySelector('input.todo-title-input');

            try {
                const response = await fetch(`/activities/api/todo/toggle/${todoId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Update UI based on completion status
                    if (data.completed) {
                        span.classList.add('line-through', 'text-[var(--color-gray-text-light)]', 'dark:text-[var(--color-gray-text-dark)]');
                        span.classList.remove('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
                        listItem.classList.add('opacity-60');
                        // Move to bottom
                        const parentDiv = listItem.parentNode;
                        parentDiv.appendChild(listItem);
                    } else {
                        span.classList.remove('line-through', 'text-[var(--color-gray-text-light)]', 'dark:text-[var(--color-gray-text-dark)]');
                        span.classList.add('text-[var(--color-text-light)]', 'dark:text-[var(--color-text-dark)]');
                        listItem.classList.remove('opacity-60');
                        // Move back to sorted position (simple re-append for now, full sort is complex client-side)
                        const parentDiv = listItem.parentNode;
                        const incompleteTasks = Array.from(parentDiv.children).filter(item => !item.querySelector('.todo-checkbox').checked);
                        if (incompleteTasks.length > 0) {
                            parentDiv.insertBefore(listItem, incompleteTasks[incompleteTasks.length - 1].nextSibling);
                        } else {
                            parentDiv.prepend(listItem); // If no incomplete tasks, put at top
                        }
                    }
                    fetchTaskSummary(); // Update task summary metrics
                } else {
                    console.error('Failed to toggle task:', data.error);
                    this.checked = !this.checked; // Revert checkbox state on error
                }
            } catch (error) {
                console.error('Error toggling task:', error);
                this.checked = !this.checked; // Revert checkbox state on error
            }
        });
    });

    // Handle task editing via AJAX
    document.querySelectorAll('.edit-todo-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const todoId = this.dataset.todoId;
            const listItem = this.closest('div.flex.items-center.justify-between');
            const titleDisplay = listItem.querySelector('.todo-title-display');
            const titleInput = listItem.querySelector('.todo-title-input');
            const editIcon = this.querySelector('.edit-icon');
            const saveIcon = this.querySelector('.save-icon');
            const csrfToken = listItem.querySelector('[name="csrfmiddlewaretoken"]').value;

            if (titleInput.classList.contains('hidden')) {
                // Currently in display mode, switch to edit mode
                titleDisplay.classList.add('hidden');
                titleInput.classList.remove('hidden');
                editIcon.classList.add('hidden');
                saveIcon.classList.remove('hidden');
                titleInput.focus();
            } else {
                // Currently in edit mode, switch to display mode and save
                const newTitle = titleInput.value.trim();
                if (newTitle === titleDisplay.textContent.trim()) {
                    // No change, just switch back
                    titleInput.classList.add('hidden');
                    titleDisplay.classList.remove('hidden');
                    editIcon.classList.remove('hidden');
                    saveIcon.classList.add('hidden');
                    return;
                }

                try {
                    const response = await fetch(`/activities/api/todo/edit/${todoId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title: newTitle })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        titleDisplay.textContent = data.title;
                        titleInput.value = data.title; // Update input value in case of future edits
                        titleInput.classList.add('hidden');
                        titleDisplay.classList.remove('hidden');
                        editIcon.classList.remove('hidden');
                        saveIcon.classList.add('hidden');
                    } else {
                        console.error('Failed to edit task:', data.error);
                        alert('Failed to save task: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error editing task:', error);
                    alert('Error saving task. Please try again.');
                }
            }
        });
    });

    // Handle Enter key press for saving task title
    document.querySelectorAll('.todo-title-input').forEach(input => {
        input.addEventListener('keydown', async function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission
                const listItem = this.closest('div.flex.items-center.justify-between');
                const editButton = listItem.querySelector('.edit-todo-btn');
                editButton.click(); // Simulate a click on the save button
            }
        });
    });

    // Handle task deletion via AJAX
    document.querySelectorAll('.delete-todo-btn').forEach(button => {
        button.addEventListener('click', async function() {
            const todoId = this.dataset.todoId;
            const listItem = this.closest('div.flex.items-center.justify-between');
            const csrfToken = listItem.querySelector('[name="csrfmiddlewaretoken"]').value;

            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    const response = await fetch(`/activities/api/todo/delete/${todoId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({})
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success) {
                        listItem.remove(); // Remove the task from the DOM
                        fetchTaskSummary(); // Update task summary metrics
                    } else {
                        console.error('Failed to delete task:', data.error);
                        alert('Failed to delete task: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error deleting task:', error);
                    alert('Error deleting task. Please try again.');
                }
            }
        });
    });

    // Re-initialize Lucide icons after any DOM manipulation that adds new icons
    // This is important for dynamically added elements like new todo items if you implement that
    lucide.createIcons();
</script>
{% endblock %}